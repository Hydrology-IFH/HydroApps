{% extends 'weatherDB\base.html' %}
{% load static %}

{% block head %}

    <!-- leaflet main -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <!-- leaflet cluster -->
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr" crossorigin="anonymous">
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" integrity="sha384-5kMSQJ6S4Qj5i09mtMNrWpSi8iXw230pKU76xTmrpezGnNJQzj0NzXjQLLg+jE7k" crossorigin="anonymous">
   <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" integrity="sha384-RLIyj5q1b5XJTn0tqUhucRZe40nFTocRP91R/NkRJHwAe4XxnTV77FXy/vGLiec2" crossorigin="anonymous"></script>

  <!-- font-awesome -->
  <link rel="stylesheet" href={% static "weatherDB/css/leaflet.awesome-markers.css" %}>
  <script src={% static "weatherDB/js/leaflet/leaflet.awesome-markers.min.js" %}></script>

    <style>
      .loading {
        display: none;
        position: fixed;
        left:50%;
        top:50%;
        transform: translate(-50%, -40%);
        z-index: 401;
        max-width: 80%;
        width: auto;
      }
      .tooltip-inner {
        max-width: 420px !important;
    }
    </style>
    <link rel="stylesheet" href="{% static "weatherDB/css/get_ts.css" %}">

{% endblock %}

{% block content %}
  <div class="loading" id="loading">
    <img src="{% static "weatherDB/loading.gif" %}">
  </div>

  <h1>Get a timeserie</h1>
  <p>To download a timeserie you can select the stations from the following map.</p>
  <form action="{% url 'weatherDB:download_ts' %}" method='post' name="download_ts" id="download_form">
    {% csrf_token %}
    <div class="row">
      <div class="col-sm-5 col-12">

        <div class="container">
          <div class="row">
            <div class="form-group input-group col-xl-6 col-12 mb-3">
              <span class="input-group-text" id="label_from">From</span>
              <input type="date" class="form-control" id="period_start" name="period_start" >
              <div class="invalid-feedback" id="invalid-feedback-period_start"><ul></ul></div>
            </div>
            <div class="form-group input-group col-xl-6 col-12 mb-3">
              <span class="input-group-text" id="label_until">Until</span>
              <input type="date" class="form-control" id="period_end" name="period_end" >
              <div class="invalid-feedback" id="invalid-feedback-period_end"><ul></ul></div>
            </div>
          </div>

          <div class="form-group input-group mb-3">
            <div class="input-group">
              <span class="input-group-text" id="label_aggregation" data-bs-toggle="tooltip" data-placement="top" data-container="body" data-bs-html="true"
                title="Choose the aggregation step you like to have.">Aggregation Step</span>
              <select class="form-control" id="aggregation" name="aggregation">
                <option value="10 min">10 minutes</option>
                <option value="hour">hourly</option>
                <option value="day" selected>daily</option>
                <option value="month">monthly</option>
                <option value="year">year</option>
              </select>
            </div>
            <div class="bs-component" id="agg_alert_box"></div>
          </div>

          <div class="form-group input-group mb-3">
            <span class="input-group-text" id="label_split_date" style="display:block" data-bs-toggle="tooltip" data-placement="top" data-bs-html="true"
              title="Which format should the timestamp column have?<ul><li>RoGeR format is one column per date part(year, month...)</li><li>string representation is one timestamp column as string (YYYY-MM-DD HH:mm:ss)</li></ul>">timestamp format</span>
            <select class="form-control" id="split_date" name="split_date">
              <option value="True" selected>RoGeR format</option>
              <option value="False">string representation</option>
            </select>
          </div>

          <div class="form-group input-group mb-3">
            <span class="input-group-text" id="label_kind" style="display:block" data-bs-toggle="tooltip" data-placement="top" data-container="body"
              title="There are different steps of timeseries creation that can get downloaded. Choose the step you would like. For more information read the method section.">data kind</span>

            <select class="form-control" id="kind" name="kind">
              <option value="best" selected>4. Richter corrected and filled</option>
              <option value="filled">3. filled</option>
              <option value="qc">2. quality checked</option>
              <option value="raw">1. raw</option>
            </select>
          </div>

          <div id="station_ids_div" class="form-group input-group mb-3">
            <span class="input-group-text" id="label_station_ids" data-bs-toggle="tooltip" data-placement="top" data-container="body" data-bs-html="true"
              title="Enter the station IDs you like as comma separated list">selected Station IDs</span>
            <textarea class="form-control" rows="1"
                    id="station_ids" name="station_ids" value=""
                    label="gewÃ¤hlte Station IDs" required></textarea>
            <div class="invalid-feedback" id="invalid-feedback-station_ids"><ul></ul></div>
          </div>

          <div class="accordion" id="accordion" class="mb-3">
            <div class="accordion-item">
              <div class="accordion-header" id="headingAccMap">
                <h5 class="mb-0">
                  <button type="button" class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseAccMap" id ="btn_colapse_card_accmap">
                    Show selection on map
                  </button>
                </h5>
              </div>
              <div id="collapseAccMap" class="collapse" aria-labelledby="headingAccMap" data-parent="#accordion">
                <div class="accordion-body">
                  <div class="row pb-1">
                    <button type="button" class="btn btn-primary me-1 col" id="btn_color_selection">Color Selection on map</button>
                    <button type="button" class="btn btn-primary col invisible" id="btn_remove_coloring">Remove Coloring</button>
                  </div>
                  <div class="row">
                    <button type="button" class="btn btn-primary me-1 col" id="btn_filter_stations">Filter Selection on map</button>
                    <button type="button" class="btn btn-primary col invisible" id="btn_remove_filter">Remove Filters</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion">
              <div class="accordion-header" id="headingAccAdd">
                <h5 class="mb-0">
                  <button type="button" class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseAccAdd" aria-expanded="false" aria-controls="collapseAccAdd" onClick="return false;" id ="btn_colapse_card_accadd">
                    Additional options
                  </button>
                </h5>
              </div>
              <div id="collapseAccAdd" class="collapse" aria-labelledby="headingAccAdd" data-parent="#accordion">
                <div class="accordion-body">
                  <div class="row pb-1">

                    <div class="form-group input-group">
                      <div class="form-check" 
                          data-bs-toggle="tooltip" data-placement="top" data-bs-html="true" data-container="body" data-bs-trigger="hover"
                          title="Should the information about the filling step be added.<ul><li>If no aggregation is done, a 'filled_by' column is added to the output, to show the Station ID from which the data was taken to fill the gap.<br>No data in this column means the measurement is a real measurement.</li><li>If the data got aggregated a filled_share column is added, giving the share of gap filled values in the aggregation group in percent.</li></ul>">
                        <input class="form-check-input" type="checkbox" value="true" id="add_filled_by" name="add_filled_by">
                        <label class="form-check-label" for="add_filled_by" autocomplete=off>
                          add gap filling information
                        </label>
                        <div class="invalid-feedback" id="invalid-feedback-add_filled_by"><ul></ul></div>
                        <div class="bs-component" id="add_filled_by_alert_box"></div>
                      </div>
                    </div>

                    <div class="form-group input-group">
                      <div class="form-check" 
                          data-bs-toggle="tooltip" data-placement="top" data-bs-html="true" data-container="body" data-bs-trigger="hover"
                          title="Should the share of NAs be added, when the value got aggregated.<br>This adds a column with the share of NA values that where in the in percent.">
                        <input class="form-check-input" type="checkbox" value="true" id="add_na_share" name="add_na_share">
                        <label class="form-check-label" for="add_na_share" >
                          add the share of NAs in the original data (only for aggregated values) 
                        </label>
                        <div class="invalid-feedback" id="invalid-feedback-add_na_share"><ul></ul></div>
                        <div class="bs-component" id="add_na_share_alert_box"></div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
          {% if needs_captcha %}
            <div id="hcaptcha_div" class="row">
              {% comment %} {% bootstrap_field hcaptchaform.hcaptcha show_label='skip' %} {% endcomment %}
              {{ hcaptchaform.hcaptcha }}
              <div id="invalid-feedback-hcaptcha" class="alert alert-danger" role="alert" style="display:none"></div>
            </div>
          {% endif %}
          <div class="col d-inline-flex justify-content-end ps-0 me-0">
            <input type="submit" value="download" name="download_ts" class="btn btn-primary mt-1" style="font-size: 20px; font-weight: 600;" id="btn_download_ts">
          </div>
        </div>
      </div>
      
      <div class="col-sm-7 col-12">
        <div id="map" style="height: 80vh"></div>
      </div>
    </div>
  </form>

{% endblock %}

{% block scripts %}
  <script type="text/javascript">
    var needs_captcha = "{{ needs_captcha }}"=="True";
    var max_downloads = {{ wdb_max_downloads }};
    var download_url = "{% url 'weatherDB:download_ts' %}";
    {% comment %} var base_url = "{% url 'weatherDB:home' %}"; {% endcomment %}
  </script>
  {{ meta_n|json_script:"meta_n-data" }}
  {% comment %} {{ needs_captcha|script:"needs_captcha" }}
  {{ wdb_max_downloads|script:"wdb_max_downloads" }} {% endcomment %}
  {% if debug %} 
    <script src={% static "weatherDB/js/get_ts_map.js" %} defer></script>
  {%else%}
    <script src={% static "weatherDB/js/get_ts_map.min.js" %} defer></script>
  {% endif%}

  <script>
    $(document).ready(function(){
      $('[data-bs-toggle="tooltip"]').tooltip();
    });
  </script>



{% endblock %}